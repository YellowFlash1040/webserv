<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Directory & File Handling Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            line-height: 1.6;
        }
        h1, h2 {
            margin-top: 2rem;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
        }
        pre {
            background: #f4f4f4;
            padding: 1rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>

<h1>Suggested Tests: Files and Directories</h1>

<p>
This site is intended to demonstrate correct server behavior for files,
directories, index resolution, autoindex, and permission errors.
All tests can be performed using a browser, EchoApi, or <code>curl</code>.
</p>

<h3>Redirect test</h3>
<p>
Request a path that is configured to return a redirect via the <code>return</code> directive.
</p>

<p>
Expected result: HTTP status <strong>302 Found</strong>. The <code>Location</code> header must be present and point to the target URL.
</p>

<pre><code>curl -i http://localhost:7071/redirect_test/</code></pre>

<h3>Method Not Allowed Test</h3>
<p>
Request a path that does not allow all methods. By default, the server allows <code>GET</code> and <code>POST</code>.
</p>

<p>
Expected result: if the method used is not allowed (for example, <code>GET</code> is blocked with <code>limit_except POST</code>), the server returns HTTP status <strong>405 Method Not Allowed</strong>. The <code>Allow</code> header must be present and indicate the allowed methods.
</p>

<pre><code>curl -i -X GET http://localhost:7071/method_test/</code></pre>

<h3>Non-existent Resource Test</h3>
<p>
Request a file or directory that does not exist on the server.
</p>

<p>
Expected result: HTTP status <strong>404 Not Found</strong>. The server should clearly indicate that the resource is missing.
</p>

<pre><code>curl -i http://localhost:7071/non_existent_file.txt
 curl -i http://localhost:7071/non_existent_directory/</code></pre>

<h3>CGI Script Test</h3>
<p>
Request a path that points to a CGI script. The server should execute the script using the configured interpreter
(<code>cgi_pass</code>) and return the script's output.
</p>

<p>
Expected result: HTTP status <strong>200 OK</strong>. The body contains the output generated by the CGI script.
</p>

<p>
Example GET request:</p>
<pre><code>curl -i http://localhost:7071/cgi_bin/test_script.py</code></pre>

<p>
Example POST request with form data:</p>
<pre><code>curl -i -X POST -d "name=Whiskers&age=3" http://localhost:7071/cgi_bin/test_script.py</code></pre>

<p>
	
<h3>Readable file</h3>
<p>
Try requesting a file that exists on disk and is readable by the server.
</p>

<p>
Expected result: HTTP status <strong>200 OK</strong>, and the file contents are returned.
</p>

<pre><code>curl -i http://localhost:7071/readable.txt</code></pre>

<h3>Unreadable file</h3>
<p>
Try requesting a file that exists on disk but is not readable by the server.
</p>

<p>
Expected result: HTTP status <strong>403 Forbidden</strong>.
</p>

<pre><code>curl -i http://localhost:7071/unreadable.txt</code></pre>

<h3>Directory with index file</h3>
	<p>
		When a directory contains an index file, the server decides which file to serve based on the <code>index</code> directive.
		By default, the server looks for <code>index.html</code>. If a location block sets its own <code>index</code>, it overwrites the default,
		and the server serves the specified file instead.
	</p>

	<p>
		Expected result: the index file (either the default <code>index.html</code> or the one defined in <code>index</code>)
		is returned with HTTP status <strong>200 OK</strong>.
	</p>

	<pre><code>curl -i http://localhost:7071/with_index/</code></pre>

<h3>Directory with custom index file (exists)</h3>
	<p>
		If a directory has a custom index file specified in the <code>index</code> directive,
		the server will serve that file instead of the default <code>index.html</code>.
	</p>

	<p>
		Expected result: the specified index file (<code>main_page.html</code>) is returned
		with HTTP status <strong>200 OK</strong>.
	</p>

	<pre><code>curl -i http://localhost:7071/custom_index_exists/</code></pre>
	
<h3>Directory with multiple index files (only last exists)</h3>
<p>
A directory specifies several index files in the <code>index</code> directive,
but only the last one exists on disk.
</p>

<p>
Expected result: the server should skip the non-existing index files and serve the first
existing one it finds. In this case, <code>index3.html</code> is served with HTTP status 
<strong>200 OK</strong>.
</p>

<pre><code>curl -i http://localhost:7071/multiple_index/</code></pre>
	
	
<h3>Directory with custom index file (missing)</h3>
	<p>
		If a directory specifies a custom index file in the <code>index</code> directive
		but that file does not exist, the server cannot serve it.
	</p>

	<p>
		Expected result: since the specified index file is missing and no other index is available,
		the server returns HTTP status <strong>403 Forbidden</strong>.
	</p>

	<pre><code>curl -i http://localhost:7071/custom_index_missing/</code></pre>
	
<h3>Index directive set, but files are not accessible</h3>
<p>
If the <code>index</code> directive is configured but none of the index files
are readable or allowed to be served, the server must deny access.
</p>

<p>
Expected result: if <code>index.html</code> exists and is readable it is served,
otherwise HTTP status <strong>403 Forbidden</strong>.
</p>

<pre><code>curl -i http://localhost:7071/index_not_readable/</code></pre>

<h3>Directory with custom missing index file (autoindex on)</h3>
<p>
This repeats the test for a directory that specifies a custom index file, but the file does not exist.
With <code>autoindex on</code>, the server should return a directory listing instead of an error.
A directory listing is returned even if the directory is empty.
</p>

<p>
Expected result: HTTP status <strong>200 OK</strong>, with a listing of the directory contents.
</p>

<pre><code>curl -i http://localhost:7071/custom_index_missing_autoindex/</code></pre>

<h3>Directory with unreadable index file (autoindex on)</h3>
<p>
This repeats the test for a directory where the index file exists but is not readable.
With <code>autoindex on</code>, the server should return a directory listing instead of a 403 error.
</p>

<p>
Expected result: HTTP status <strong>200 OK</strong>, with a listing of the directory contents.
</p>

<pre><code>curl -i http://localhost:7071/index_not_readable_autoindex/</code></pre>

<h3>Directory without autoindex and without index file</h3>
<p>
If the directory exists but no index file is found and <code>autoindex</code>
is disabled, access must be denied.
</p>

<p>
Expected result: HTTP status <strong>403 Forbidden</strong>.
</p>

<pre><code>curl -i http://localhost:7071/no_index_no_autoindex/</code></pre>

<h3>Error page fallback: Method Not Allowed (405)</h3>
<p>
This test demonstrates what happens when a configured <code>error_page</code> is missing.
Right now, the server has a custom error page for 405 errors, so a request using a
disallowed method shows the custom-made error page.
</p>

<p>
To run this test, comment out the <code>error_page 405 /errors/405.html;;</code>
directive in your configuration file, then reload the server.
</p>

<p>
Repeat a request that triggers the same error, for example using <code>GET</code>
on a location configured with <code>limit_except POST</code>.
</p>

<p>
Expected result: HTTP status remains <strong>405 Method Not Allowed</strong>, but the
response body is now the <strong>Default Error Page</strong> instead of the custom one.
The <code>Allow</code> header should still be present indicating the allowed methods.
</p>

<pre><code>curl -i -X GET http://localhost:7071/method_test/</code></pre>

<h3>DELETE Non-Existent File Test</h3>
<p>
Attempt to delete a file in the <code>/delete_nonexistent_file/</code> location.
The directory exists but is <strong>empty</strong>, so the requested file does not exist.
</p>

<p>
Expected result: HTTP status <strong>404 Not Found</strong>. The server should indicate
that the resource cannot be deleted because it does not exist.
</p>

<pre><code>curl -i -X DELETE http://localhost:7071/delete_nonexistent_file/non_existing_file.txt</code></pre>

<h3>DELETE File Without Permissions Test</h3>
<p>
Attempt to delete a file in the <code>/delete_no_permission/</code> location
for which the server does not have write permissions.
</p>

<p>
Expected result: HTTP status <strong>403 Forbidden</strong>. The server should
prevent deletion due to insufficient permissions.
</p>

<pre><code>curl -i -X DELETE http://localhost:7071/delete_no_permission/no_permission_file.txt</code></pre>

<h3>DELETE Test: Remove an existing file</h3>
<p>
This test demonstrates deleting a file using the <code>DELETE</code> method.
Use the existing <code>delete_test</code> directory and create a file named <code>temp_file.txt</code> inside it.
Make sure the file has proper read/write permissions for the server.

Expected result: The server returns HTTP status <strong>204 No Content</strong> and the file is removed from disk.
</p>

<pre><code>curl -i -X DELETE http://localhost:7071/delete_test/temp_file.txt</code></pre>

<h3>POST Test: Successful File Upload</h3>
<p>
Send a POST request with a small body to a location configured for file uploads.
The server configuration currently sets <code>client_max_body_size 20M;</code> in the http scope,
so small requests are accepted.
</p>

<p>
Expected result: HTTP status <strong>201 Created</strong>, and the response includes a message
with the stored file path.
</p>

<pre><code>curl -i -X POST -H "Content-Type: text/plain" \
     --data-binary "Hello world!" \
     http://localhost:7071/upload_post/raw.txt
</code></pre>

<h3>POST Test: Body Exceeding Overridden Limit</h3>
<p>
The server configuration in the <code>http</code> scope sets a global maximum request body size of <code>client_max_body_size 20M;</code>.
To test how the server behaves when a location overrides this limit, modify the <code>/upload_post/</code> location by setting 
<code>client_max_body_size 10;</code>. This overrides the global 20M limit just for this location.
</p>

<p>
Then, send a POST request with a body larger than 10 bytes (for example, <code>"Hello world!"</code>). 
This should fail because the body exceeds the overridden limit.
</p>

<p>
Expected result: HTTP status <strong>413 Payload Too Large</strong>.
</p>

<pre><code>curl -i -X POST -H "Content-Type: text/plain" \
     --data-binary "Hello world!" \
     http://localhost:7071/upload_post/tiny_file.txt
</code></pre>

<h3>Directory Not Accessible Test</h3>
<p>
Request a directory that exists and contains files, but the directory itself has no read/execute rights.
Even though the files inside are readable, the server cannot access them.
</p>

<p>
Expected result: HTTP status <strong>403 Forbidden</strong>. The server should deny access because the directory cannot be opened.
</p>

<pre><code>curl -i http://localhost:7071/dir_not_accessible/</code></pre>

<p>
Run the following commands <strong>once before starting the tests</strong>.
They create files and directories with specific permission restrictions
required for the permission-related test cases above.
</p>

<pre><code>
# DELETE: file without permissions
touch ./assets/www/site3/delete_no_permission/no_permission_file.txt
chmod 000 ./assets/www/site3/delete_no_permission/no_permission_file.txt

# Index file exists but is not readable
touch ./assets/www/site3/index_not_readable/unreadable.txt
chmod 000 ./assets/www/site3/index_not_readable/unreadable.txt

# Index file not readable, autoindex ON
touch ./assets/www/site3/index_not_readable_autoindex/unreadable.txt
chmod 000 ./assets/www/site3/index_not_readable_autoindex/unreadable.txt

# Unreadable standalone file
touch ./assets/www/site3/unreadable.txt
chmod 000 ./assets/www/site3/unreadable.txt

# Directory not accessible, files inside are readable
mkdir -p ./assets/www/site3/dir_not_accessible
echo "This file is fine" > ./assets/www/site3/dir_not_accessible/file.txt
chmod 644 ./assets/www/site3/dir_not_accessible/file.txt
chmod 000 ./assets/www/site3/dir_not_accessible
</code></pre>

</body>
</html>
